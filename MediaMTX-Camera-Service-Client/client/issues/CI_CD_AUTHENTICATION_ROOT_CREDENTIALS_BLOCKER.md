# CI/CD Authentication Root Credentials Blocker

## Issue Summary
**Priority:** MEDIUM  
**Type:** CI/CD BLOCKER  
**Impact:** Automated testing and deployment blocked  
**Status:** INVESTIGATION REQUIRED  
**Root Cause:** `set-test-env.sh` requires sudo privileges for JWT key generation

## Problem Description
The current test environment setup requires root credentials via `sudo` in `set-test-env.sh`, which blocks automated CI/CD environments where:
- No user is present to provide root credentials
- Security policies prevent sudo access
- Containers run as non-root users
- Automated pipelines cannot handle interactive prompts

### **Current Blocking Flow:**
```bash
# REQUIRED for tests to work:
cd MediaMTX-Camera-Service-Client/client
./set-test-env.sh  # ❌ REQUIRES SUDO - BLOCKS CI/CD
source .test_env
npm test
```

### **CI/CD Failure Scenario:**
```bash
# In CI/CD environment:
npm test
# ❌ FAILS: "sudo: a password is required"
# ❌ FAILS: "sudo: no tty present and no askpass program specified"
# ❌ FAILS: "This incident will be reported"
```

## Root Cause Analysis

### **1. JWT Key Generation Requires Root**
- **Current Process:** `set-test-env.sh` uses `sudo` to generate JWT keys
- **Why Root:** Likely accessing system-wide configuration or hardware
- **Impact:** Blocks all automated environments

### **2. Environment Variable Dependency**
- **Current Dependency:** `CAMERA_SERVICE_JWT_SECRET` must be set
- **Source:** Generated by `set-test-env.sh` with sudo
- **Fallback:** None - tests fail without this variable

### **3. No Alternative Authentication Path**
- **Current:** Only JWT authentication supported
- **Missing:** API key, environment-based, or file-based alternatives
- **Impact:** No workaround for CI/CD environments

## Investigation Required

### **1. JWT Key Generation Analysis**
**Question:** Why does JWT key generation require root privileges?

**Possible Reasons:**
- Accessing system-wide configuration files
- Hardware-based key generation
- System service communication
- File permission requirements

**Investigation Tasks:**
- [ ] Analyze `set-test-env.sh` script to identify sudo requirement
- [ ] Check if JWT keys can be generated without root
- [ ] Identify alternative key generation methods
- [ ] Review server authentication requirements

### **2. Server Authentication Analysis**
**Question:** Can the server accept alternative authentication methods?

**Possible Alternatives:**
- [ ] API key authentication (no JWT required)
- [ ] Environment variable-based authentication
- [ ] File-based authentication (config files)
- [ ] No authentication for local development
- [ ] Pre-generated JWT keys for CI/CD

**Investigation Tasks:**
- [ ] Review server authentication documentation
- [ ] Test alternative authentication methods
- [ ] Check if server supports multiple auth modes
- [ ] Identify minimal authentication requirements

### **3. CI/CD Environment Analysis**
**Question:** What authentication methods work in CI/CD environments?

**CI/CD Constraints:**
- No interactive user input
- No sudo privileges
- Limited file system access
- Security restrictions
- Container-based execution

**Investigation Tasks:**
- [ ] Test current setup in CI/CD environment
- [ ] Identify available authentication methods
- [ ] Check environment variable capabilities
- [ ] Review container security policies

## Required Solutions

### **Solution 1: Non-Root JWT Generation (PREFERRED)**
```bash
# TARGET: Generate JWT keys without sudo
./set-test-env-no-root.sh  # ✅ No sudo required
source .test_env
npm test  # ✅ Works in CI/CD
```

**Implementation:**
- Modify JWT generation to work without root
- Use user-specific directories for key storage
- Implement alternative key generation methods
- Update `set-test-env.sh` to detect and avoid sudo when possible

### **Solution 2: Alternative Authentication Methods**
```bash
# TARGET: Use API keys or environment variables
export CAMERA_SERVICE_API_KEY="ci-cd-api-key"
npm test  # ✅ Works in CI/CD
```

**Implementation:**
- Add API key authentication support
- Use environment variables for CI/CD
- Implement file-based configuration
- Add authentication method detection

### **Solution 3: Pre-Generated Keys for CI/CD**
```bash
# TARGET: Use pre-generated keys for automated environments
export CAMERA_SERVICE_JWT_SECRET="pre-generated-ci-cd-secret"
npm test  # ✅ Works in CI/CD
```

**Implementation:**
- Generate and store CI/CD JWT keys securely
- Use different keys for different environments
- Implement key rotation for security
- Add key validation and expiration

### **Solution 4: No Authentication for Local Development**
```bash
# TARGET: Skip authentication for local development
export CAMERA_SERVICE_NO_AUTH=true
npm test  # ✅ Works in CI/CD
```

**Implementation:**
- Add no-auth mode for development
- Implement authentication bypass for localhost
- Add security warnings for production use
- Maintain authentication for remote connections

## Implementation Priority

### **HIGH PRIORITY (Immediate):**
1. **Investigate JWT generation requirements** - Why does it need root?
2. **Test alternative authentication methods** - What does the server support?
3. **Implement non-root JWT generation** - Remove sudo dependency

### **MEDIUM PRIORITY (Next Sprint):**
1. **Add API key authentication** - Alternative to JWT
2. **Implement environment-based auth** - Use environment variables
3. **Add CI/CD specific configuration** - Pre-generated keys

### **LOW PRIORITY (Future):**
1. **Implement key rotation** - Security enhancement
2. **Add authentication method detection** - Automatic fallback
3. **Enhance security documentation** - Best practices

## Success Criteria

### **Immediate Goals:**
- ✅ JWT generation works without sudo
- ✅ Tests run in CI/CD environment
- ✅ No interactive prompts required
- ✅ Maintains security requirements

### **Short-term Goals:**
- ✅ Multiple authentication methods supported
- ✅ CI/CD environment fully automated
- ✅ Local development simplified
- ✅ Security requirements maintained

### **Long-term Goals:**
- ✅ Robust authentication system
- ✅ Key rotation and management
- ✅ Comprehensive documentation
- ✅ Security best practices implemented

## Impact
- **Current State:** CI/CD blocked by root requirements
- **Target State:** Fully automated CI/CD pipeline
- **Improvement:** Automated testing and deployment
- **Security:** Maintained or improved authentication

## Files Affected
- `set-test-env.sh` - Main script requiring sudo
- `package.json` - Test scripts and CI/CD configuration
- `.test_env` - Environment variable file
- Server authentication configuration
- CI/CD pipeline configuration

## Testing Instructions
```bash
# Test current blocking behavior:
cd MediaMTX-Camera-Service-Client/client
./set-test-env.sh  # ❌ Requires sudo - blocks CI/CD

# Test alternative approaches:
export CAMERA_SERVICE_API_KEY="test-key"
npm test  # Test API key authentication

export CAMERA_SERVICE_NO_AUTH=true
npm test  # Test no-auth mode

# Test in CI/CD environment:
docker run --rm -v $(pwd):/app -w /app node:18 npm test
```

## Notes
- **Security First:** Any solution must maintain security requirements
- **Backward Compatibility:** Changes should not break existing setups
- **Documentation:** All changes must be documented
- **Testing:** All solutions must be tested in CI/CD environment
- **Gradual Migration:** Support multiple authentication methods during transition

## Related Issues
- Authentication setup integration test failures
- Environment variable configuration issues
- CI/CD pipeline configuration
