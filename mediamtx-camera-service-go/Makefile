# MediaMTX Camera Service Makefile
# Provides convenient commands for development and documentation

.PHONY: help build test clean docs-validate docs-audit docs-generate docs-serve

# Default target
help:
	@echo "MediaMTX Camera Service - Available Commands"
	@echo "============================================="
	@echo ""
	@echo "Development:"
	@echo "  build          - Build the camera service"
	@echo "  test           - Run all tests"
	@echo "  test-coverage  - Run tests with coverage report"
	@echo "  clean          - Clean build artifacts"
	@echo ""
	@echo "Documentation:"
	@echo "  docs-validate  - Validate documentation against implementation"
	@echo "  docs-audit     - Run comprehensive documentation audit"
	@echo "  docs-generate  - Generate API documentation from code"
	@echo "  docs-serve     - Serve documentation locally"
	@echo ""
	@echo "Quality Assurance:"
	@echo "  lint           - Run code linting"
	@echo "  format         - Format code"
	@echo "  security       - Run security checks"
	@echo ""
	@echo "Deployment:"
	@echo "  install        - Install the service"
	@echo "  uninstall      - Uninstall the service"
	@echo "  restart        - Restart the service"

# Build the camera service
build:
	@echo "ğŸ”¨ Building camera service..."
	go build -o camera-service ./cmd/camera-service
	@echo "âœ… Build completed"

# Run all tests
test:
	@echo "ğŸ§ª Running tests..."
	go test -v ./...
	@echo "âœ… Tests completed"

# Run tests with coverage
test-coverage:
	@echo "ğŸ§ª Running tests with coverage..."
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"

# Integration Tests (cross-package coverage)
integration-cover:
	@echo "ğŸ§ª Running integration tests with coverage..."
	@mkdir -p coverage/integration
	@go test ./tests/integration/... -coverpkg=./internal/... -coverprofile=coverage/integration/integration.out -v
	@go tool cover -func=coverage/integration/integration.out | tail -1

integration-cover-html:
	@mkdir -p coverage/integration
	@go test ./tests/integration/... -coverpkg=./internal/... -coverprofile=coverage/integration/integration.out -v
	@go tool cover -html=coverage/integration/integration.out -o coverage/integration/integration.html
	@echo "âœ… HTML: coverage/integration/integration.html"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -f camera-service
	rm -f coverage.out coverage.html
	rm -rf /tmp/implemented_methods.txt
	rm -rf /tmp/documented_methods.txt
	rm -rf /tmp/missing_docs.txt
	rm -rf /tmp/extra_docs.txt
	@echo "âœ… Clean completed"

# Validate documentation
docs-validate:
	@echo "ğŸ“š Validating documentation..."
	@chmod +x scripts/validate-documentation.sh
	@./scripts/validate-documentation.sh
	@echo "âœ… Documentation validation completed"

# Run comprehensive documentation audit
docs-audit:
	@echo "ğŸ“Š Running documentation audit..."
	@echo "ğŸ“‹ Implementation vs Documentation Audit"
	@echo "======================================"
	@chmod +x scripts/validate-documentation.sh
	@./scripts/validate-documentation.sh
	@echo ""
	@echo "ğŸ“ˆ Documentation Coverage Report"
	@echo "==============================="
	@if [ -f "/tmp/implemented_methods.txt" ]; then \
		echo "Implemented methods: $$(wc -l < /tmp/implemented_methods.txt)"; \
	fi
	@if [ -f "/tmp/documented_methods.txt" ]; then \
		echo "Documented methods: $$(wc -l < /tmp/documented_methods.txt)"; \
	fi
	@if [ -f "/tmp/missing_docs.txt" ]; then \
		echo "Missing documentation: $$(wc -l < /tmp/missing_docs.txt)"; \
		if [ -s "/tmp/missing_docs.txt" ]; then \
			echo ""; \
			echo "Missing methods:"; \
			cat /tmp/missing_docs.txt | sed 's/^/  - /'; \
		fi; \
	fi
	@if [ -f "/tmp/extra_docs.txt" ]; then \
		echo "Extra documentation: $$(wc -l < /tmp/extra_docs.txt)"; \
		if [ -s "/tmp/extra_docs.txt" ]; then \
			echo ""; \
			echo "Extra methods:"; \
			cat /tmp/extra_docs.txt | sed 's/^/  - /'; \
		fi; \
	fi

# Generate API documentation from code
docs-generate:
	@echo "ğŸ“ Generating API documentation from code..."
	@echo "Extracting methods from implementation..."
	@grep -r "Method.*func" ./internal/websocket/ | \
		grep -v test | \
		grep -o '"[^"]*"' | \
		sed 's/"//g' | \
		sort | uniq > /tmp/generated_methods.txt
	@echo "Generated methods list: /tmp/generated_methods.txt"
	@echo "âœ… API documentation generation completed"

# Serve documentation locally
docs-serve:
	@echo "ğŸŒ Serving documentation locally..."
	@if command -v python3 >/dev/null 2>&1; then \
		python3 -m http.server 8080 --directory docs/; \
	elif command -v python >/dev/null 2>&1; then \
		python -m SimpleHTTPServer 8080; \
	else \
		echo "âŒ Python not found. Please install Python to serve documentation."; \
		exit 1; \
	fi

# Run code linting
lint:
	@echo "ğŸ” Running code linting..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not found. Installing..."
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
		golangci-lint run; \
	fi
	@echo "âœ… Linting completed"

# Format code
format:
	@echo "ğŸ¨ Formatting code..."
	go fmt ./...
	@echo "âœ… Code formatting completed"

# Run security checks
security:
	@echo "ğŸ”’ Running security checks..."
	@if command -v gosec >/dev/null 2>&1; then \
		gosec ./...; \
	else \
		echo "âš ï¸  gosec not found. Installing..."
		go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
		gosec ./...; \
	fi
	@echo "âœ… Security checks completed"

# Install the service
install:
	@echo "ğŸ“¦ Installing camera service..."
	@sudo cp camera-service /opt/camera-service/
	@sudo cp -r config /opt/camera-service/
	@sudo cp -r docs /opt/camera-service/
	@sudo chown -R camera-service:camera-service /opt/camera-service
	@sudo systemctl enable camera-service
	@sudo systemctl start camera-service
	@echo "âœ… Service installed and started"

# Uninstall the service
uninstall:
	@echo "ğŸ—‘ï¸  Uninstalling camera service..."
	@sudo systemctl stop camera-service
	@sudo systemctl disable camera-service
	@sudo rm -rf /opt/camera-service
	@echo "âœ… Service uninstalled"

# Restart the service
restart:
	@echo "ğŸ”„ Restarting camera service..."
	@sudo systemctl restart camera-service
	@echo "âœ… Service restarted"

# Development setup
dev-setup:
	@echo "ğŸ› ï¸  Setting up development environment..."
	@echo "Installing development tools..."
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
	@echo "Setting up git hooks..."
	@cp scripts/pre-commit-doc-validation.sh .git/hooks/pre-commit
	@chmod +x .git/hooks/pre-commit
	@echo "âœ… Development environment setup completed"

# Full quality check
quality-check: lint format security test docs-validate
	@echo "âœ… Full quality check completed"

# Documentation workflow
docs-workflow: docs-validate docs-audit docs-generate
	@echo "âœ… Documentation workflow completed"

# Complete development workflow
dev-workflow: clean build test docs-validate lint security
	@echo "âœ… Complete development workflow completed"