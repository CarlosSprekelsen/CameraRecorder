# API Key Setup Guide

**Version:** 1.0  
**Status:** Production Ready  
**Epic:** E3 Client API & SDK Ecosystem  

## Overview

This guide provides comprehensive information about API key setup and management for the MediaMTX Camera Service, including key generation, validation, rotation, and best practices.

## API Key Structure

### Key Format

API keys follow a specific format for easy identification and validation:

```
camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef
```

**Components:**
- **Prefix**: `camera_service_sk_` (16 characters)
- **Key**: 64-character random string (alphanumeric)
- **Total Length**: 80 characters

### Key Validation

```python
import re

def validate_api_key_format(api_key: str) -> bool:
    """
    Validate API key format.
    
    Args:
        api_key: API key string to validate
    
    Returns:
        True if valid format, False otherwise
    """
    pattern = r'^camera_service_sk_[a-zA-Z0-9]{64}$'
    return bool(re.match(pattern, api_key))

# Example usage
api_key = "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
if validate_api_key_format(api_key):
    print("✅ Valid API key format")
else:
    print("❌ Invalid API key format")
```

## API Key Generation

### Server-Side Generation

API keys are generated by the MediaMTX Camera Service server using secure random generation:

```bash
# Generate API key via REST API
curl -X POST http://localhost:8002/api/keys \
    -H "Content-Type: application/json" \
    -d '{
        "name": "Service Key",
        "role": "operator",
        "expires_at": "2025-12-31T23:59:59Z"
    }'

# Response
{
    "key_id": "key_1234567890abcdef",
    "api_key": "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
    "name": "Service Key",
    "role": "operator",
    "created_at": "2025-01-15T10:30:00Z",
    "expires_at": "2025-12-31T23:59:59Z"
}
```

### Python Key Generation (Client-Side)

```python
import secrets
import string
from typing import Optional

def generate_api_key(prefix: str = "camera_service_sk_") -> str:
    """
    Generate a secure API key.
    
    Args:
        prefix: Key prefix (default: camera_service_sk_)
    
    Returns:
        Generated API key
    """
    # Generate 64 random alphanumeric characters
    alphabet = string.ascii_letters + string.digits
    key_part = ''.join(secrets.choice(alphabet) for _ in range(64))
    
    return prefix + key_part

def generate_api_key_with_validation() -> str:
    """
    Generate API key and validate format.
    
    Returns:
        Valid API key
    """
    api_key = generate_api_key()
    
    # Validate the generated key
    if not validate_api_key_format(api_key):
        raise ValueError("Generated API key has invalid format")
    
    return api_key

# Example usage
api_key = generate_api_key()
print(f"Generated API key: {api_key}")
print(f"Key length: {len(api_key)} characters")
print(f"Valid format: {validate_api_key_format(api_key)}")
```

### Node.js Key Generation (Client-Side)

```javascript
const crypto = require('crypto');

function generateApiKey(prefix = 'camera_service_sk_') {
    /**
     * Generate a secure API key.
     * 
     * @param {string} prefix - Key prefix (default: camera_service_sk_)
     * @returns {string} Generated API key
     */
    // Generate 64 random alphanumeric characters
    const keyPart = crypto.randomBytes(32).toString('hex');
    return prefix + keyPart;
}

function validateApiKeyFormat(apiKey) {
    /**
     * Validate API key format.
     * 
     * @param {string} apiKey - API key string to validate
     * @returns {boolean} True if valid format, false otherwise
     */
    const pattern = /^camera_service_sk_[a-zA-Z0-9]{64}$/;
    return pattern.test(apiKey);
}

function generateApiKeyWithValidation() {
    /**
     * Generate API key and validate format.
     * 
     * @returns {string} Valid API key
     */
    const apiKey = generateApiKey();
    
    // Validate the generated key
    if (!validateApiKeyFormat(apiKey)) {
        throw new Error('Generated API key has invalid format');
    }
    
    return apiKey;
}

// Example usage
const apiKey = generateApiKey();
console.log(`Generated API key: ${apiKey}`);
console.log(`Key length: ${apiKey.length} characters`);
console.log(`Valid format: ${validateApiKeyFormat(apiKey)}`);
```

## API Key Management

### List API Keys

```bash
# List all API keys
curl -X GET http://localhost:8002/api/keys

# Response
{
    "keys": [
        {
            "key_id": "key_1234567890abcdef",
            "name": "Service Key",
            "role": "operator",
            "created_at": "2025-01-15T10:30:00Z",
            "expires_at": "2025-12-31T23:59:59Z",
            "last_used": "2025-01-15T15:30:00Z"
        }
    ]
}
```

### Get API Key Details

```bash
# Get specific API key details
curl -X GET http://localhost:8002/api/keys/key_1234567890abcdef

# Response
{
    "key_id": "key_1234567890abcdef",
    "name": "Service Key",
    "role": "operator",
    "created_at": "2025-01-15T10:30:00Z",
    "expires_at": "2025-12-31T23:59:59Z",
    "last_used": "2025-01-15T15:30:00Z",
    "usage_count": 42
}
```

### Rotate API Key

```bash
# Rotate API key (generate new key, invalidate old one)
curl -X POST http://localhost:8002/api/keys/key_1234567890abcdef/rotate

# Response
{
    "key_id": "key_1234567890abcdef",
    "new_api_key": "camera_service_sk_newkey1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
    "name": "Service Key",
    "role": "operator",
    "rotated_at": "2025-01-15T16:00:00Z"
}
```

### Revoke API Key

```bash
# Revoke API key
curl -X DELETE http://localhost:8002/api/keys/key_1234567890abcdef

# Response
{
    "message": "API key revoked successfully",
    "key_id": "key_1234567890abcdef"
}
```

## Python API Key Management

```python
import requests
import json
from typing import Dict, List, Optional

class APIKeyManager:
    def __init__(self, base_url: str = "http://localhost:8002"):
        self.base_url = base_url
        self.api_keys_endpoint = f"{base_url}/api/keys"
    
    def create_api_key(self, name: str, role: str, expires_at: Optional[str] = None) -> Dict:
        """
        Create a new API key.
        
        Args:
            name: Key name/description
            role: User role (viewer, operator, admin)
            expires_at: Expiration date (ISO format)
        
        Returns:
            API key information
        """
        data = {
            "name": name,
            "role": role
        }
        
        if expires_at:
            data["expires_at"] = expires_at
        
        response = requests.post(self.api_keys_endpoint, json=data)
        response.raise_for_status()
        
        return response.json()
    
    def list_api_keys(self) -> List[Dict]:
        """
        List all API keys.
        
        Returns:
            List of API key information
        """
        response = requests.get(self.api_keys_endpoint)
        response.raise_for_status()
        
        return response.json()["keys"]
    
    def get_api_key(self, key_id: str) -> Dict:
        """
        Get API key details.
        
        Args:
            key_id: API key ID
        
        Returns:
            API key information
        """
        response = requests.get(f"{self.api_keys_endpoint}/{key_id}")
        response.raise_for_status()
        
        return response.json()
    
    def rotate_api_key(self, key_id: str) -> Dict:
        """
        Rotate API key.
        
        Args:
            key_id: API key ID
        
        Returns:
            New API key information
        """
        response = requests.post(f"{self.api_keys_endpoint}/{key_id}/rotate")
        response.raise_for_status()
        
        return response.json()
    
    def revoke_api_key(self, key_id: str) -> Dict:
        """
        Revoke API key.
        
        Args:
            key_id: API key ID
        
        Returns:
            Revocation confirmation
        """
        response = requests.delete(f"{self.api_keys_endpoint}/{key_id}")
        response.raise_for_status()
        
        return response.json()

# Example usage
key_manager = APIKeyManager()

# Create new API key
new_key = key_manager.create_api_key("Test Service", "operator")
print(f"Created API key: {new_key['api_key']}")

# List all keys
keys = key_manager.list_api_keys()
for key in keys:
    print(f"Key: {key['name']} ({key['role']}) - {key['key_id']}")

# Rotate key
rotated_key = key_manager.rotate_api_key(new_key['key_id'])
print(f"New API key: {rotated_key['new_api_key']}")

# Revoke key
result = key_manager.revoke_api_key(new_key['key_id'])
print(f"Revoked: {result['message']}")
```

## Node.js API Key Management

```javascript
const axios = require('axios');

class APIKeyManager {
    constructor(baseUrl = 'http://localhost:8002') {
        this.baseUrl = baseUrl;
        this.apiKeysEndpoint = `${baseUrl}/api/keys`;
    }
    
    async createApiKey(name, role, expiresAt = null) {
        /**
         * Create a new API key.
         * 
         * @param {string} name - Key name/description
         * @param {string} role - User role (viewer, operator, admin)
         * @param {string} expiresAt - Expiration date (ISO format)
         * @returns {object} API key information
         */
        const data = {
            name,
            role
        };
        
        if (expiresAt) {
            data.expires_at = expiresAt;
        }
        
        const response = await axios.post(this.apiKeysEndpoint, data);
        return response.data;
    }
    
    async listApiKeys() {
        /**
         * List all API keys.
         * 
         * @returns {array} List of API key information
         */
        const response = await axios.get(this.apiKeysEndpoint);
        return response.data.keys;
    }
    
    async getApiKey(keyId) {
        /**
         * Get API key details.
         * 
         * @param {string} keyId - API key ID
         * @returns {object} API key information
         */
        const response = await axios.get(`${this.apiKeysEndpoint}/${keyId}`);
        return response.data;
    }
    
    async rotateApiKey(keyId) {
        /**
         * Rotate API key.
         * 
         * @param {string} keyId - API key ID
         * @returns {object} New API key information
         */
        const response = await axios.post(`${this.apiKeysEndpoint}/${keyId}/rotate`);
        return response.data;
    }
    
    async revokeApiKey(keyId) {
        /**
         * Revoke API key.
         * 
         * @param {string} keyId - API key ID
         * @returns {object} Revocation confirmation
         */
        const response = await axios.delete(`${this.apiKeysEndpoint}/${keyId}`);
        return response.data;
    }
}

// Example usage
async function main() {
    const keyManager = new APIKeyManager();
    
    try {
        // Create new API key
        const newKey = await keyManager.createApiKey('Test Service', 'operator');
        console.log(`Created API key: ${newKey.api_key}`);
        
        // List all keys
        const keys = await keyManager.listApiKeys();
        keys.forEach(key => {
            console.log(`Key: ${key.name} (${key.role}) - ${key.key_id}`);
        });
        
        // Rotate key
        const rotatedKey = await keyManager.rotateApiKey(newKey.key_id);
        console.log(`New API key: ${rotatedKey.new_api_key}`);
        
        // Revoke key
        const result = await keyManager.revokeApiKey(newKey.key_id);
        console.log(`Revoked: ${result.message}`);
        
    } catch (error) {
        console.error('Error:', error.message);
    }
}

main();
```

## API Key Usage Examples

### Python Client

```python
import asyncio
from examples.python.camera_client import CameraClient

async def main():
    # API key for authentication
    api_key = "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    
    # Create client with API key authentication
    client = CameraClient(
        host="localhost",
        port=8080,
        auth_type="api_key",
        api_key=api_key
    )
    
    try:
        # Connect and authenticate automatically
        await client.connect()
        
        # Use the client
        cameras = await client.get_camera_list()
        print(f"Found {len(cameras)} cameras")
        
        # Take a snapshot
        if cameras:
            snapshot = await client.take_snapshot(cameras[0].device_path)
            print(f"Snapshot taken: {snapshot.filename}")
        
    finally:
        await client.disconnect()

asyncio.run(main())
```

### JavaScript Client

```javascript
import { CameraClient } from './examples/javascript/camera_client.js';

async function main() {
    // API key for authentication
    const apiKey = 'camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef';
    
    // Create client with API key authentication
    const client = new CameraClient({
        host: 'localhost',
        port: 8080,
        authType: 'api_key',
        apiKey: apiKey
    });
    
    try {
        // Connect and authenticate automatically
        await client.connect();
        
        // Use the client
        const cameras = await client.getCameraList();
        console.log(`Found ${cameras.length} cameras`);
        
        // Take a snapshot
        if (cameras.length > 0) {
            const snapshot = await client.takeSnapshot(cameras[0].devicePath);
            console.log(`Snapshot taken: ${snapshot.filename}`);
        }
        
    } finally {
        await client.disconnect();
    }
}

main().catch(console.error);
```

### CLI Client

```bash
# Use API key with CLI
python examples/cli/camera_cli.py \
    --host localhost \
    --port 8080 \
    --auth-type api_key \
    --key "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef" \
    list

# Take snapshot with API key
python examples/cli/camera_cli.py \
    --host localhost \
    --port 8080 \
    --auth-type api_key \
    --key "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef" \
    snapshot /dev/video0
```

## Security Best Practices

### 1. Secure Key Storage

```python
import os
from cryptography.fernet import Fernet

class SecureKeyStorage:
    def __init__(self, key_file: str = "~/.camera_service_keys"):
        self.key_file = os.path.expanduser(key_file)
        self.cipher_key = os.environ.get("CAMERA_SERVICE_CIPHER_KEY")
        
        if not self.cipher_key:
            self.cipher_key = Fernet.generate_key()
            print(f"Generated cipher key: {self.cipher_key.decode()}")
        
        self.cipher = Fernet(self.cipher_key)
    
    def store_api_key(self, key_name: str, api_key: str):
        """Store API key securely."""
        encrypted_key = self.cipher.encrypt(api_key.encode())
        
        with open(self.key_file, 'a') as f:
            f.write(f"{key_name}:{encrypted_key.decode()}\n")
    
    def get_api_key(self, key_name: str) -> Optional[str]:
        """Retrieve API key securely."""
        if not os.path.exists(self.key_file):
            return None
        
        with open(self.key_file, 'r') as f:
            for line in f:
                name, encrypted_key = line.strip().split(':', 1)
                if name == key_name:
                    decrypted_key = self.cipher.decrypt(encrypted_key.encode())
                    return decrypted_key.decode()
        
        return None

# Example usage
storage = SecureKeyStorage()
storage.store_api_key("service_key", "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef")
api_key = storage.get_api_key("service_key")
```

### 2. Environment Variable Management

```bash
#!/bin/bash
# Set API key environment variable

# For development
export CAMERA_SERVICE_API_KEY="camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"

# For production (use secure storage)
# export CAMERA_SERVICE_API_KEY=$(aws secretsmanager get-secret-value --secret-id camera-service-api-key --query SecretString --output text)
```

### 3. Key Rotation Strategy

```python
import asyncio
from datetime import datetime, timedelta

class APIKeyRotationManager:
    def __init__(self, key_manager: APIKeyManager):
        self.key_manager = key_manager
        self.rotation_interval = timedelta(days=30)  # Rotate every 30 days
    
    async def check_and_rotate_keys(self):
        """Check and rotate keys that are approaching expiration."""
        keys = await self.key_manager.list_api_keys()
        
        for key in keys:
            created_at = datetime.fromisoformat(key['created_at'].replace('Z', '+00:00'))
            age = datetime.now(created_at.tzinfo) - created_at
            
            if age > self.rotation_interval:
                print(f"Rotating key: {key['name']}")
                try:
                    new_key = await self.key_manager.rotate_api_key(key['key_id'])
                    print(f"New key generated: {new_key['new_api_key']}")
                except Exception as e:
                    print(f"Failed to rotate key {key['key_id']}: {e}")

# Example usage
async def main():
    key_manager = APIKeyManager()
    rotation_manager = APIKeyRotationManager(key_manager)
    
    await rotation_manager.check_and_rotate_keys()

asyncio.run(main())
```

### 4. Key Usage Monitoring

```python
import time
from collections import defaultdict

class APIKeyMonitor:
    def __init__(self):
        self.usage_stats = defaultdict(lambda: {
            'count': 0,
            'last_used': None,
            'errors': 0
        })
    
    def record_usage(self, key_id: str, success: bool = True):
        """Record API key usage."""
        stats = self.usage_stats[key_id]
        stats['count'] += 1
        stats['last_used'] = time.time()
        
        if not success:
            stats['errors'] += 1
    
    def get_usage_report(self) -> Dict:
        """Generate usage report."""
        report = {}
        for key_id, stats in self.usage_stats.items():
            report[key_id] = {
                'total_requests': stats['count'],
                'error_rate': stats['errors'] / stats['count'] if stats['count'] > 0 else 0,
                'last_used': datetime.fromtimestamp(stats['last_used']) if stats['last_used'] else None
            }
        return report

# Example usage
monitor = APIKeyMonitor()

# Record usage
monitor.record_usage("key_123", success=True)
monitor.record_usage("key_123", success=False)
monitor.record_usage("key_456", success=True)

# Get report
report = monitor.get_usage_report()
for key_id, stats in report.items():
    print(f"Key {key_id}: {stats['total_requests']} requests, {stats['error_rate']:.2%} error rate")
```

## Error Handling

### Common API Key Errors

```python
def handle_api_key_errors(api_key: str) -> Dict:
    """Handle common API key errors."""
    errors = []
    
    # Check format
    if not validate_api_key_format(api_key):
        errors.append("Invalid API key format")
    
    # Check length
    if len(api_key) != 80:
        errors.append(f"Invalid API key length: {len(api_key)} (expected 80)")
    
    # Check prefix
    if not api_key.startswith("camera_service_sk_"):
        errors.append("Invalid API key prefix")
    
    # Check characters
    if not api_key[16:].isalnum():
        errors.append("API key contains invalid characters")
    
    return {
        "valid": len(errors) == 0,
        "errors": errors
    }

# Example usage
api_key = "invalid_key"
result = handle_api_key_errors(api_key)
if not result["valid"]:
    print("API key errors:")
    for error in result["errors"]:
        print(f"  - {error}")
```

## Testing API Keys

### Test Key Generation

```python
def test_api_key_generation():
    """Test API key generation and validation."""
    # Generate test key
    api_key = generate_api_key()
    print(f"Generated key: {api_key}")
    
    # Validate format
    if validate_api_key_format(api_key):
        print("✅ Key format validation passed")
    else:
        print("❌ Key format validation failed")
    
    # Test invalid keys
    invalid_keys = [
        "short_key",
        "camera_service_sk_invalid",
        "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef_extra",
        "camera_service_sk_1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcde@"
    ]
    
    for invalid_key in invalid_keys:
        if not validate_api_key_format(invalid_key):
            print(f"✅ Correctly rejected invalid key: {invalid_key[:20]}...")
        else:
            print(f"❌ Incorrectly accepted invalid key: {invalid_key[:20]}...")

if __name__ == "__main__":
    test_api_key_generation()
```

## Support

For additional support and questions:

- **Documentation**: See `docs/security/CLIENT_AUTHENTICATION_GUIDE.md`
- **Examples**: Check `examples/` directory for working examples
- **Issues**: Report problems via GitHub Issues
- **Email**: Contact team@mediamtx-camera-service.com
